volumes:
  ny_taxi_postgres_data:
    driver: local
  kestra_postgres_data:
    driver: local
  kestra_data:
    driver: local
  # New volumes for Spark logs
  spark_master_logs:
  spark_worker_logs:
  spark_event_logs:

networks:
  kestra-spark-network:
    name: kestra-spark-network
    driver: bridge

services:
  spark-master:
    image: apache/spark:4.0.1-java21-r
    container_name: spark-master
    user: root
    command: ["/opt/spark/bin/spark-class", "org.apache.spark.deploy.master.Master"]
    ports:
      - "38080:8080"
      - "37077:7077"
    environment:
      - SPARK_MASTER_OPTS=--add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/sun.nio.ch=ALL-UNNAMED --add-opens=java.base/javax.security.auth=ALL-UNNAMED -Djdk.security.allowNonCausingSubstitutions=true
      - SPARK_DRIVER_JAVA_OPTS=-Djdk.security.allowNonCausingSubstitutions=true
      # Enable Event Logging (for History Server)
      - SPARK_HISTORY_OPTS=-Dspark.history.fs.logDirectory=/opt/spark/event-logs
    volumes:
      - ./service-account.json:/opt/spark/conf/gcp-key.json:ro
      - ./pyspark/spark_job.py:/opt/spark/work-dir/spark_job.py
      - ./data:/opt/spark/work-dir/data 
      - spark_master_logs:/opt/spark/logs          # Persist System Logs
      - spark_event_logs:/opt/spark/event-logs      # Persist App History Logs
    networks:
      - kestra-spark-network
    restart: unless-stopped

  spark-worker:
    image: apache/spark:4.0.1-java21-r
    container_name: spark-worker
    user: root
    depends_on:
      - spark-master
    command: ["/opt/spark/bin/spark-class", "org.apache.spark.deploy.worker.Worker", "spark://spark-master:7077"]
    environment:
      - SPARK_WORKER_CORES=1
      - SPARK_WORKER_MEMORY=1G
      - SPARK_WORKER_OPTS=--add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/sun.nio.ch=ALL-UNNAMED --add-opens=java.base/javax.security.auth=ALL-UNNAMED -Djdk.security.allowNonCausingSubstitutions=true
      - SPARK_EXECUTOR_JAVA_OPTS=-Djdk.security.allowNonCausingSubstitutions=true
    volumes:
      - ./service-account.json:/opt/spark/conf/gcp-key.json:ro
      - ./data:/opt/spark/work-dir/data 
      - spark_worker_logs:/opt/spark/logs          # Persist Worker System Logs
      - spark_event_logs:/opt/spark/event-logs      # Share Event log dir
    networks:
      - kestra-spark-network
    restart: unless-stopped

  # OPTIONAL: Spark History Server to view logs after jobs finish
  spark-history-server:
    image: apache/spark:4.0.1-java21-r
    container_name: spark-history-server
    command: ["/opt/spark/bin/spark-class", "org.apache.spark.deploy.history.HistoryServer"]
    ports:
      - "18080:18080"
    environment:
      - SPARK_HISTORY_OPTS=-Dspark.history.fs.logDirectory=/opt/spark/event-logs
    volumes:
      - spark_event_logs:/opt/spark/event-logs
    networks:
      - kestra-spark-network

  kestra_postgres:
    image: postgres:18
    volumes:
      - kestra_postgres_data:/var/lib/postgresql/data # LOGS ARE SAVED HERE
    environment:
      POSTGRES_DB: kestra
      POSTGRES_USER: kestra
      POSTGRES_PASSWORD: k3str4
    networks:
      - kestra-spark-network

  kestra:
    image: kestra/kestra:v1.1
    user: "root"
    command: server standalone
    volumes:
      - kestra_data:/app/storage
      - /var/run/docker.sock:/var/run/docker.sock
      - /tmp/kestra-wd:/tmp/kestra-wd
      - ~/.gcp/workflow-orchestration-credentials.json:/.gcp/credentials.json
    # ... rest of your config ...
    env_file: .env_encoded
    environment:
      KESTRA_CONFIGURATION: |
        datasources:
          postgres:
            url: jdbc:postgresql://kestra_postgres:5432/kestra
            driverClassName: org.postgresql.Driver
            username: kestra
            password: k3str4
        kestra:
          storage:
            type: local
            local:
              basePath: "/app/storage"
          repository:
            type: postgres
          queue:
            type: postgres
        tasks:
          scripts:
            docker:
              volumes:
                enabled: true
    ports:
      - "8080:8080"
      - "8081:8081"
    networks:
      - kestra-spark-network
    depends_on:
      kestra_postgres:
        condition: service_started

  # (Your other services like pgdatabase and pgadmin should also join 'kestra-spark-network')
